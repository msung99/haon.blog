---
title: Jenkins, Nginx ë°°í¬ í™˜ê²½ì—ì„œ ë°œìƒí•˜ëŠ” ë‹¤ìš´íƒ€ì„ì„ ì˜¨ì „íˆ ì œê±°í•  ìˆ˜ ìˆì„ê¹Œ?
date: "2023-05-27"
tags:
  - ë¬´ì¤‘ë‹¨ë°°í¬
  - Jenkins
  - Nginx
previewImage: infra.png
series: CI/CD ë¬´ì¤‘ë‹¨ë°°í¬ ì•„í‚¤í…ì²˜ ê°œì„  ê³¼ì •
---

## í•™ìŠµë°°ê²½

[[CI/CD & Nginx] Worker Process íŠœë‹ìœ¼ë¡œ ë‹¤ìš´íƒ€ì„ì„ 0.015ì´ˆë¡œ ì¤„ì´ê¸° ê¹Œì§€ì˜ ê°œì„ ê³¼ì •](https://velog.io/@msung99/CICD-Nginx-Worker-Process-%ED%8A%9C%EB%8B%9D%EC%9C%BC%EB%A1%9C-%EB%8B%A4%EC%9A%B4%ED%83%80%EC%9E%84%EC%9D%84-0.015%EC%B4%88%EB%A1%9C-%EC%A4%84%EC%9D%B4%EA%B8%B0-%EA%B9%8C%EC%A7%80%EC%9D%98-%EA%B0%9C%EC%84%A0%EA%B3%BC%EC%A0%95) ì—ì„œ ë‹¤ë£¨ì—ˆë“¯ì´, Nginx ëŠ” reload ì‹œ ì•„ì£¼ ì§§ì€ ë‹¤ìš´íƒ€ì„ì´ ë°œìƒí•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ Nginx ê³µì‹ë¬¸ì„œì—ì„œëŠ” gracefully shutdown ì„ ì§€ì›í•¨ìœ¼ë¡œì¨, `ì œë¡œíƒ€ì„(zero-downtime)` ì´ ê°€ëŠ¥ì¼€í•œë‹¤ê³  ì£¼ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ, ì‹¤ì œë¡œëŠ” reload ì‹œ ë‹¤ìš´íƒ€ì„ì´ ë°œìƒí•˜ê³  ìˆìœ¼ë©°, ì´ëŠ” graceful í•˜ì§€ ëª»í•©ë‹ˆë‹¤.

> ì´ë²ˆì—ëŠ” Nginx ì˜ ë¬¸ì œì ì„ ë¶„ì„í•˜ê³ , ì œê°€ ì–´ë–»ê²Œ ì œë¡œíƒ€ì„ì„ êµ¬í˜„í•  ìˆ˜ ìˆì„ì§€ì— ëŒ€í•´ ê³ ë¯¼í•œ í”ì ì— ëŒ€í•´ ë‹¤ë£¨ê³ ì í•©ë‹ˆë‹¤.

---

## ë¬¸ì œ ë°œìƒìƒí™© : ê¸‰í•œ ë¶ˆì€ ê»ëŠ”ë°.. ğŸ”¥

![](https://velog.velcdn.com/images/msung99/post/9c63f663-5376-437d-891f-58116c93fda5/image.png)

[[CI/CD & Nginx] Worker Process íŠœë‹ìœ¼ë¡œ ë‹¤ìš´íƒ€ì„ì„ 0.015ì´ˆë¡œ ì¤„ì´ê¸° ê¹Œì§€ì˜ ê°œì„ ê³¼ì •](https://velog.io/@msung99/CICD-Nginx-Worker-Process-%ED%8A%9C%EB%8B%9D%EC%9C%BC%EB%A1%9C-%EB%8B%A4%EC%9A%B4%ED%83%80%EC%9E%84%EC%9D%84-0.015%EC%B4%88%EB%A1%9C-%EC%A4%84%EC%9D%B4%EA%B8%B0-%EA%B9%8C%EC%A7%80%EC%9D%98-%EA%B0%9C%EC%84%A0%EA%B3%BC%EC%A0%95) ì—ì„œë„ ê³„ì† ë´¤ë˜ ë¬¸ì œ ìƒí™©ì´ì§€ë§Œ, `Blue/Green ë°°í¬ ì•„í‚¤í…ì²˜` ì—ì„œ ë‹¤ìš´íƒ€ì„ì„ ê°œì„ í•˜ëŠ”ë° ê¹Œì§€ ë§ì€ ê°œì„ ì‚¬í•­ì´ ìˆì—ˆê³ , ê²°êµ­ ë‹¤ìš´íƒ€ì„ì„ 0.3ì´ˆì—ì„œ ì‹œì‘í•´ì„œ 0.015ì´ˆê¹Œì§€ ê°ì†Œì‹œí‚¤ëŠ”ê²ƒì€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜, ì•„ì§ ë‹¤ìš´íƒ€ì„ì´ ë°œìƒí•œë‹¤ëŠ” ê·¸ ê·¼ë³¸ì ì¸ ë¬¸ì œëŠ” í•´ê²°ë˜ì§€ ì•Šì•˜ìœ¼ë©°, ì´ë¥¼ í•´ê²°í•˜ê³ ì Nginx ì˜ ê³µì‹ë¬¸ì„œì—ì„œ ì£¼ì¥í•˜ëŠ” `Nginx Graceful Shutdown` ì˜ íŠ¹ì§•ì— ëŒ€í•´ ê¹Šê²Œ íŒŒí•´ì³ ë´¤ìŠµë‹ˆë‹¤.

---

## Nginx ì˜ reload ì˜ ëª¨ìˆœ

[Nginx ê³µì‹ë¬¸ì„œ](https://www.nginx.com/faq/how-does-zero-downtime-configuration-testingreload-in-nginx-plus-work/) ì—ì„œ ë§í•˜ê¸°ë¥¼, `nginx -s reload` ëª…ë ¹ì€ í˜„ì¬ ì‹¤í–‰ì¤‘ì¸ Nginx í”„ë¡œì„¸ìŠ¤ì— reload ì‹œê·¸ë„ì„ ë³´ëƒ…ë‹ˆë‹¤. Nginx í”„ë¡œì„¸ëŠ” nginx.conf ì˜ ì„¤ì •ì •ë³´ë¥¼ ë‹¤ì‹œ ì½ì–´ë“¤ì—¬ì„œ ë¦¬ë²„ìŠ¤í”„ë¡ì‹œë§Œ ë°”ê¾¸ë©´ì„œ Blue/Green ë°°í¬ê°€ ê°€ëŠ¥í•˜ë‹¤ê³  ì£¼ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì•ì„œ ê³„ì† ë´¤ë“¯ì´, Nginx ëŠ” reloading ì‹œì— ì•„ì£¼ ì§§ì€ ë‹¤ìš´íƒ€ì„ì´ ë°œìƒí•˜ëŠ” ëª¨ìˆœì´ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ëŠ” graceful í•˜ì§€ ëª»í•˜ë‹¤ê³  ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## í´ë¼ì´ì–¸íŠ¸ì™€ Nginx ì„œë²„ê°„ì˜ TCP ì»¤ë„¥ì…˜ ì²˜ë¦¬ ë°©ì‹

Nginx ì˜ reload ì‹œ ë‚´ë¶€ ë™ì‘ë°©ì‹ì„ ì´í•´í•˜ê³  ì™œ reload ì‹œ ë‹¤ìš´íƒ€ì„ì´ ë°œìƒí•˜ëŠ”ì§€ ì´í•´í•˜ë ¤ë©´, ë¨¼ì € í´ë¼ì´ì–¸íŠ¸ì™€ nginx ì„œë²„ ì‚¬ì´ì—ì„œ ì–´ë–»ê²Œ TCP ì»¤ë„¥ì…˜ì„ ë§ºê³  ì²˜ë¦¬í•˜ëŠ”ì§€ë¥¼ ì´í•´í•´ì•¼í•©ë‹ˆë‹¤.

- ìš°ì„  í´ë¼ì´ì–¸íŠ¸ì™€ Nginx ì„œë²„ì˜ IP í¬íŠ¸ë¡œ TCP ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤.
- nginx ì„œë²„ëŠ” í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì„ ìˆ˜ì‹ í•˜ê³ , í•´ë‹¹ ìš”ì²­ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ Worker Process ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ë¥¼ í• ë‹¹í•©ë‹ˆë‹¤.
- í• ë‹¹ëœ ì›Œì»¤ëŠ” ìš”ì²­ì— ëŒ€í•œ ì²˜ë¦¬ì‘ì—…ì„ ìˆ˜í–‰í•˜ê³ , HTTP ì‘ë‹µì„ í´ë¼ì´ì–¸íŠ¸ì— ë³´ëƒ…ë‹ˆë‹¤.
- í´ë¼ì´ì–¸íŠ¸ ë˜ëŠ” ì„œë²„ì˜ ì–´ëŠ í•œìª½ì— ì—°ê²°ì„ ì¢…ë£Œí•˜ë ¤ëŠ” ê²½ìš°, TCP ì»¤ë„¥ì…˜ì€ ì¢…ë£Œë©ë‹ˆë‹¤. ì»¤ë„¥ì…˜ì´ ëŠì–´ì§€ê²Œ ë˜ë©´, í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ëŠ” **ì¢…ë£Œëœ ì»¤ë„¥ì…˜ìœ¼ë¡œ ë” ì´ìƒ ë°ì´í„° êµí™˜ì„ í•  ìˆ˜ ì—†ê²Œ ë©ë‹ˆë‹¤.**

ì—¬ê¸°ì„œ ì¤‘ì ìœ¼ë¡œ ë´ì•¼í•  ë¶€ë¶„ì€ "ì¢…ë£Œëœ(ëŠì–´ì§„) ì»¤ë„¥ì…˜ìœ¼ë¡œ ë°ì´í„° êµí™˜ì´ ë” ì´ìƒ ë¶ˆê°€ëŠ¥í•˜ë‹¤" ëŠ”ì  ì…ë‹ˆë‹¤. ë‹¹ì—°í•œ ë§ì´ì§€ë§Œ, **ì–´ë–¤ ì»¤ë„¥ì…˜ì´ ì¢…ë£Œë˜ì—ˆë‹¤ë©´ í•´ë‹¹ ì»¤ë„¥ì…˜ìœ¼ë¡œëŠ” ë‹¤ì‹œ ìš”ì²­ì´ ë¶ˆê°€ëŠ¥**í•˜ë¯€ë¡œ ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ì„ ìƒì„±í•´ì„œ ì¬ìš”ì²­ì„ í–ˆì„ë•Œë§Œ ì„œë²„ì—ì„œ ìš”ì²­ì„ ì²˜ë¦¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.

### Connection : keep-value

ë˜, HTTP Header ì˜ Connection ì˜ value ê°’ìœ¼ë¡œ "keep-alive" ì™€ "close" ì†ì„±ì„ ë¶€ì—¬ ê°€ëŠ¥í•©ë‹ˆë‹¤. í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° ì˜¨ íŒ¨í‚·ì„ ëœ¯ì–´ë´¤ì„ë•Œ keep-alive ì†ì„±ì´ ë¶€ì—¬ëœ íŒ¨í‚·ì´ë¼ë©´, í•´ë‹¹ nginx ì„œë²„ì— ì„¤ì •ëœ `keep-alive` ë§Œí¼ ì»¤ë„¥ì…˜ì´ ìœ ì§€ë©ë‹ˆë‹¤. ì¦‰, `keep-alive=60s;`ë¡œ ì§€ì •ëœ ê²½ìš°ë¼ë©´ í´ë¼ì´ì–¸íŠ¸ëŠ” TCP ì—°ê²°ì„ ë§¤ë²ˆ ì¬ì‹œë„ í•  í•„ìš”ì—†ì´ 60ì´ˆ ë™ì•ˆ í•´ë‹¹ ì»¤ë„¥ì…˜ìœ¼ë¡œ ê³„ì† ìš”ì²­ì„ ì‹œë„í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

---

## Nginx ì˜ reload ì‹œ ë‚´ë¶€ ë™ì‘ë°©ì‹

Nginx ì˜ ì‹¤ì œ ë‚´ë¶€ë™ì‘ ë°©ì‹ì„ ì•Œë©´, graceful í•˜ì§€ ëª»í•˜ë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê²°ë¡ ë¶€í„° ë§í•˜ìë©´, HTTP Header ì˜ connection = keep-alive ìœ¼ë¡œ ë¶€ì—¬ëœê²½ìš°, ë¬¸ì œê°€ ë°œìƒí•˜ê²Œë©ë‹ˆë‹¤.

> - Nginx ê°€ reload ì‹œê·¸ë„ì„ ë°›ìŠµë‹ˆë‹¤.

- ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ë“¤ì€ í˜„ì¬ ì²˜ë¦¬ì¤‘ì¸ http ìš”ì²­ê¹Œì§€ë§Œ ì‘ë‹µí•˜ê³ , tcp ì»¤ë„¥ì…˜ì„ ëŠì–´ë²„ë¦½ë‹ˆë‹¤.
- ë§Œì•½ í´ë¼ì´ì–¸íŠ¸ì˜ http header ì˜ Connection ì˜ value ê°€ "keep-alive" ìœ¼ë¡œ ì„¤ì •ë˜ì–´ìˆëŠ” ê²½ìš°, ì•ì„œ ì—°ê²°ì´ ëŠì–´ì§„ tcp ì»¤ë„¥ì…˜ìœ¼ë¡œ ì¬ìš”ì²­ì„ ì‹œë„í•´ì„œ ì—ëŸ¬ê°€ ë°œìƒí•˜ê²Œ ë©ë‹ˆë‹¤.

### keep-alive ë¡œ ì§€ì •ëœ ê²½ìš°

![](https://velog.velcdn.com/images/msung99/post/72646d43-ba85-43e9-bb23-ee11a1ee79ab/image.png)

keep-alive ë¡œ ì§€ì •ëœ ê²½ìš°ë¥¼ ê°€ì •í•´ë´…ì‹œë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ [HTTP/1.1 Connection í—¤ë”](https://datatracker.ietf.org/doc/html/rfc2616#section-8.1) ì—ì„œëŠ” `Connection: Keep-alive` í—¤ë”ê°€ ì¡´ì¬í•  ê²½ìš° tcp ì»¤ë„¥ì…˜ì„ ì¬ì‚¬ìš©í•˜ë„ë¡ í•©ë‹ˆë‹¤. ìœ„ì™€ ê°™ì´ í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­ì„ ìµœì´ˆë¡œ ì‹œë„í•œë‹¤ë©´ ì»¤ë„¥ì…˜ì„ ìƒˆë¡­ê²Œ ìƒì„±í•©ë‹ˆë‹¤. ë˜ keep-alive ì†ì„±ìœ¼ë¡œ ì¸í•´, keep-alive = 60s; ì¸ ê²½ìš°ë¥¼ ê°€ì •í•œë‹¤ë©´ 60ì´ˆ ë™ì•ˆ í•´ë‹¹ ì»¤ë„¥ì…˜ìœ¼ë¡œ ìš”ì²­ì„ ì¬ì‹œë„í•˜ê²Œ ë©ë‹ˆë‹¤.

### ë‹¤ìš´íƒ€ì„ ë°œìƒì›ì¸

![](https://velog.velcdn.com/images/msung99/post/6e83e21f-31af-4412-a82e-b7c4d19869c9/image.png)

ê·¸ëŸ°ë° nginx -s reload ë¥¼ ìˆ˜í–‰í•œ ê²½ìš°ë¥¼ ìƒê°í•´ë´…ì‹œë‹¤. ê·¸ëŸ¬ë©´ ìƒˆë¡œìš´ worker process ê°€ ìƒì„±ë˜ê³  Nginx ì— ì˜í•´ ì»¤ë„¥ì…˜ì´ ëŠì–´ì§€ê²Œ(ì¢…ë£Œ) ë©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜, ê¸°ì¡´ì— ì»¤ë„¥ì…˜ì„ ìƒì„±í•œ í´ë¼ì´ì–¸íŠ¸ëŠ” keep-alive ì†ì„±ìœ¼ë¡œ ì¸í•´ ì—¬ì „íˆ Nginx ì— ì˜í•´ ëŠê¸´ TCP ì»¤ë„¥ì…˜ì„ í†µí•´ HTTP ìš”ì²­ì„ ì¬ìƒì„±í•˜ê³  í•´ì„œ ì—ëŸ¬ê°€ ë°œìƒí•˜ê²Œë˜ê³ , í•´ë‹¹ ìš”ì²­ì€ ì‹¤íŒ¨í•˜ê²Œ ë©ë‹ˆë‹¤. ì´ë•Œ ë°”ë¡œ ë‹¤ìš´íƒ€ì„ì´ ë°œìƒí•˜ê²Œ ë˜ëŠ” ê²ƒì´ë©°, í´ë¼ì´ì–¸íŠ¸ëŠ” ìƒˆë¡œìš´ TCP ì»¤ë„¥ì…˜ì„ í†µí•´ì„œ ì¬ìš”ì²­ì„ ì‹œë„í•´ì•¼í•©ë‹ˆë‹¤.

---

## HTTP/1.1 Connecion í—¤ë”

ì•ì„œ ë§ì”€ë“œë ¸ë“¯ì´, HTTP/1.1 ìŠ¤íŒ©ì€ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ëŠ” ì‘ë‹µì— `Connection: Keep-alive` í—¤ë”ê°€ ì¡´ì¬í•  ê²½ìš° TCP ì»¤ë„¥ì…˜ì„ ì¬ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. HTTP/1.1 ì€ Connection í—¤ë”ì˜ ë””í´íŠ¸ ê°’ì´ Keep-alive ì´ê³ , ì´ëŠ” Connection í—¤ë”ë¥¼ ë”°ë¡œ ì„¤ì •í•˜ì§€ ì•ŠëŠ” ì´ìƒ í•­ìƒ TCP ì»¤ë„¥ì…˜ì„ ì¬ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

### Connection: close

ê·¸ë ‡ë‹¤ë©´ ë‹¨ìˆœí•˜ê²Œ keep-alive ëŒ€ì‹ ì— `Connecion: close` í—¤ë”ë¥¼ í†µí•´ ë§¤ë²ˆ ìš”ì²­ì„ ë³´ë‚¼ë•Œë§ˆë‹¤ TCP ì—°ê²°ì„ ë§ºê³ ë‚˜ì„œ ì‘ì—…ë‚´ìš©ì„ ì²˜ë¦¬í›„ ì¬í™œìš©ì—†ì´ ë°”ë¡œ ì¢…ë£Œë˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¦‰, í´ë¼ì´ì–¸íŠ¸ëŠ” ë§¤ë²ˆ ìš”ì²­ì„ ë³´ë‚¼ë–„ `Connection: close` ë¥¼ ëª…ì‹œí•´ì„œ ë§¤ë²ˆ ìš”ì²­ì„ ìˆ˜í–‰í•œ í›„ì—ëŠ” ì¦‰ì‹œ ì»¤ë„¥ì…˜ì„ ì¬í™œìš©í•˜ì§€ ì•Šê³  ì¢…ë£Œì‹œí‚¤ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ, ì´ ë°©ì‹ì„ í™œìš©ì‹œ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œì ì„ ì§€ë‹ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- 1. ë§¤ ìš”ì²­ë§ˆë‹¤ TCP ì»¤ë„¥ì…˜ì„ ë§ºì–´ì•¼í•˜ë‹ˆ, ì˜¤ë²„í•´ë“œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
- 2. í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ì‚¬ì´ì— Connection: close ì´ìš©ì„ í•˜ê² ë‹¤ëŠ” ê·œì•½ì„ ë§ºì–´ì•¼í•©ë‹ˆë‹¤.

HTTP1.1 ìŠ¤íŒ©ìƒ, Connection: close ì´ìš©ì„ ê°•ì œí•˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. íŠ¹íˆ ìœ„ 2ë²ˆì˜ ê²½ìš° Connection: close ë¥¼ ì´ìš©í•˜ê² ë‹¤ëŠ” ê·œì•½ì„ íŠ¹ë³„íˆ ë§ºì–´ì•¼í•œë‹¤ëŠ” ë²ˆê±°ë¡œì›€ì´ ë°œìƒí•˜ê¸°ë„ í•˜ì£ . ì´ ë‹¨ìˆœí•œ ë°©ë²•ë³´ë‹¤ëŠ”, keep-alive ì†ì„±ì„ ê³„ì† ìœ ì§€í•˜ë©´ì„œë„ `reload` ê°€ ë˜ëŠ” íƒ€ì´ë°ì— ìœ ì˜í•´ì„œ ì»¤ë„¥ì…˜ì„ ì²˜ë¦¬í•´ì£¼ëŠ” ë” íš¨ìœ¨ì ì¸ ë°©ë²•ì´ í•„ìš”í• ê²ë‹ˆë‹¤.

---

## close ë¼ë©´ ì œë¡œíƒ€ì„ êµ¬í˜„ì´ ê°€ëŠ¥í•˜ë‹¤

ë§Œì•½ HTTP/1.1 ì˜ ê¶Œì¥ ìŠ¤íŒ©ì„ ë²—ì–´ë‚˜ì„œ keep-alive ê°€ ì•„ë‹ˆë¼ close ë¥¼ ì‚¬ìš©í•˜ê²Œ ëœë‹¤ë©´ ì œë¡œ ë‹¤ìš´íƒ€ì„(zero-downtime) êµ¬í˜„ì´ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.

### add_header

ë§Œì•½ ìœ„ ë°©ë²•ì„ ì ìš©í•˜ê³  ì‹¶ë‹¤ë©´, ì„¤ì •ë°©ë²•ì€ ì•„ë˜ì™€ ê°™ì´ "close" ëŠ” ì§€ì •í•´ì£¼ë©´ ë©ë‹ˆë‹¤. Nginx ê°€ Connecion: close í—¤ë”ë¥¼ ì‘ë‹µì— ì¶”ê°€ë˜ë„ë¡ ì„¤ì •í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ëŸ¬ë©´ ë§¤ë²ˆ ì»¤ë„¥ì…˜ì„ ìƒˆë¡­ê²Œ keep-alive ìœ¼ë¡œ ìƒì„±í•˜ê³ , í•´ë‹¹ íŒ¨í‚·ë“¤ì„ í•­ìƒ close ë¡œ ë³€í™˜í•˜ì—¬ ì‘ë‹µí•´ì£¼ê²Œ ë©ë‹ˆë‹¤.

```java
server{
        listen 80;

        include /etc/nginx/conf.d/service-url.inc;

        location / {
                add_header Connection "close";
                proxy_pass $service_url;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
        }
}
```

### ë‹¤ìš´íƒ€ì„ í…ŒìŠ¤íŠ¸

ì‹¤ì œë¡œ ìš”ì²­ì„ ë³´ë‚´ë´¤ì„ë•Œ, ë‹¨ í•œê±´ì˜ ìš”ì²­ë„ ì‹¤íŒ¨í•˜ëŠ” ê²ƒì—†ì´ ì œë¡œ ë‹¤ìš´íƒ€ì„ì´ êµ¬í˜„ë˜ëŠ” ëª¨ìŠµì„ í™•ì¸ ê°€ëŠ¥í–ˆìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ë¥¼ 10ë²ˆ ë„˜ê²Œ ëŒë ¸ì„ë•Œ, ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë‹¤ìš´íƒ€ì„ ì´ìŠˆë¥¼ í•´ê²°í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

---

## keep-alive ê°€ ì‚´ì•„ìˆëŠ”í•œ ì™„ë²½í•œ ì œë¡œíƒ€ì„ì„ ë§Œë“œëŠ” ê²ƒì€ ë¶ˆê°€ëŠ¥í•˜ë‹¤

### ì´ìƒì ì¸ ë°©í–¥ : reload íƒ€ì´ë°ì—ë§Œ TCP ì»¤ë„¥ì…˜ì„ ì¬ìƒì„±í•˜ê¸°

ì»¤ë„¥ì…˜ ì´ìŠˆë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ë©°ì¹ ë™ì•ˆ ë§ì€ ìƒê°ê³¼ ê³ ë¯¼ì´ ìˆì—ˆìŠµë‹ˆë‹¤. ì•„ì‰½ê²Œë„ ê·¸ ê³¼ì •ì—ì„œ ë– ì˜¬ë ¤ë´¤ë˜ ì•„ë˜ì™€ ê°™ì€ ë°©ë²•ì´ ìˆì—ˆëŠ”ë°, ì´ëŠ” êµ¬í˜„ì´ ë¶ˆê°€ëŠ¥ì— ê°€ê¹ë‹¤ê³  íŒë‹¨ë˜ì–´ì„œ ìµœì„ ì˜ í•´ê²°ì±…ìœ¼ë¡œë§Œ ë‚¨ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.

![](https://velog.velcdn.com/images/msung99/post/13af4008-6a4f-4aec-8c0a-7ea7f8383c2f/image.png)

> ì´ ë°©ì‹ì€ êµ¬í˜„ì´ ë§¤ìš° ë³µì¡í•˜ê¸° ë–„ë¬¸ì— ì œê³µë˜ì§€ ì•ŠëŠ” ê¸°ëŠ¥ì´ë¼ê³  í•©ë‹ˆë‹¤.

í•´ê²°ì±…ìœ¼ë¡œ ìƒê°í–ˆë˜ ìµœì„ ì˜ ë°©ë²•ì€ ìœ„ì™€ê°™ì´ ë°”ë¡œ í‰ì†Œì— ë“¤ì–´ì˜¨ keep-alive ë¥¼ ê³„ì† ìœ ì§€í•˜ë‹¤ê°€, reload ì‹œì ì—ë§Œ ì»¤ë„¥ì…˜ì„ ëŠì–´ë²„ë¦¬ê³  í´ë¼ì´ì–¸íŠ¸ê°€ ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ì„ ìƒì„±í•˜ë„ë¡ ìœ ë„í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤. ì¦‰, ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ëŠ” reload ì‹œì ì—ë§Œ `Connection: close` í—¤ë”ë¥¼ ì‘ë‹µìœ¼ë¡œ ì „ì†¡í•´ì„œ í´ë¼ì´ì–¸íŠ¸ê°€ ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ì„ ì„¤ì •í•˜ë„ë¡ ìœ ë„í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ë ‡ê²Œí•˜ë©´ ê¸°ì¡´ì— ëŠì–´ì§„ TCP ì»¤ë„¥ì…˜ì„ ì¬í™œìš©í•˜ë ¤ëŠ” ì‹œë„ë¥¼ ë°©ì§€í•˜ë©´ì„œ, ë‹¤ìš´íƒ€ì„ì„ ë°©ì§€í•  ìˆ˜ ìˆê²Œ ë ê²ë‹ˆë‹¤.

í•˜ì§€ë§Œ, ì•„ì‰½ê²Œë„ ì´ ê¸°ëŠ¥ì„ êµ¬í˜„í•  ë°©ë²•ì€ í˜„ì¬ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê²°êµ­ Nginx ë¡œ ì™„ë²½í•œ ì œë¡œ ë‹¤ìš´íƒ€ì„(zero-downtime) ì„ ë§Œë“œëŠ”ê²ƒì€ ì‚¬ì‹¤ìƒ ë¶ˆê°€ëŠ¥ì— ê°€ê¹ë‹¤ê³  ë³´ëŠ”ê²Œ ë§ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤.

### ì´ë²¤íŠ¸ í›…(Evevt Hook)

ì´ì— ëŒ€í•œ í•´ê²°ì±…ìœ¼ë¡ , `ì´ë²¤íŠ¸ í›…(Hook)` ì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì´ ìˆê¸´í•©ë‹ˆë‹¤. ì´ë²¤íŠ¸ í›…ì€ Nginxì˜ íŠ¹ì • ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì‹¤í–‰ë˜ëŠ” ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ì…ë‹ˆë‹¤. ì´ë¥¼ í™œìš©í•˜ì—¬ nginx -s reload ëª…ë ¹ ì‹¤í–‰ ì‹œì ì—ì„œ ì›í•˜ëŠ” ë™ì‘ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆê¸´ í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, `ngx_lua ëª¨ë“ˆ`ì„ ì‚¬ìš©í•˜ì—¬ Lua ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•˜ê³ , í•´ë‹¹ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì´ë²¤íŠ¸ í›…ìœ¼ë¡œ ë“±ë¡í•˜ì—¬ ì‹¤í–‰í•˜ëŠ” ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ, ì´ë¥¼ êµ¬í˜„í•˜ëŠ” ê²ƒì€ ì •ë§ ì–´ë µê¸°ë•Œë¬¸ì— ê±°ì˜ ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

---

## ì œë¡œíƒ€ì„ì— ë” ê°€ê¹Œì›Œì§€ê¸° ìœ„í•œ ì„±ëŠ¥ê°œì„ 

í•˜ì§€ë§Œ ì œë¡œíƒ€ì„ì— ë” ê°€ê¹Œì›Œ ì§€ê¸°ìœ„í•´, ë” íš¨ìœ¨ì ì¸ ì„¤ì •ì„ ì¶©ë¶„íˆ ê³ ë¯¼í•´ë³´ì•˜ìŠµë‹ˆë‹¤. ì´ëŠ” ë¶ˆì•ˆì •í•œ ì²˜ë¦¬ë¥¼ ë” ì•ˆì •ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ê¸° ìœ„í•¨ì´ê¸°ë„ í•©ë‹ˆë‹¤. ê·¸ ë°©ë²•ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

### 1) worker_shutdown_timeout

```java
worker_shutdown_timeout 1s;
```

worker_shutdown_timeout ê°’ì€ graceful shutdownì´ ì´ë£¨ì–´ì§€ëŠ” ë™ì•ˆì—ë„ ê° ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ê°€ ì¶”ê°€ ìš”ì²­ì„ ë°›ì„ ìˆ˜ ìˆëŠ” ì‹œê°„ì„ ì§€ì •í•©ë‹ˆë‹¤.

ì´ë¥¼ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ì´ìœ ëŠ” ìš°ì„  `keep-alive` ë•Œë¬¸ì…ë‹ˆë‹¤. í´ë¼ì´ì–¸íŠ¸ì™€ì˜ Keep-Alive ì—°ê²°ì„ í†µí•´ ì—¬ëŸ¬ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ê²½ìš°, ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œë˜ê¸° ì „ì— ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì€ ìš”ì²­ì´ ë‚¨ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ ë™ì¼í•œ ì—°ê²°ì„ ì¬ì‚¬ìš©í•˜ì—¬ ì¶”ê°€ ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ì£ .

### 2) keepalive_timeout

ë‹¤ìŒìœ¼ë¡œ keep-alive ë„ íƒ€ì„ì•„ì›ƒ ì§€ì •ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì•„ë˜ì²˜ëŸ¼ ì‘ì„±ì‹œ í´ë¼ì´ì–¸íŠ¸ì™€ Nginx ê°„ì˜ keep-alive ì—°ê²°ì´ 3ì´ˆê°„ ìœ ì§€ë˜ëŠ” ê²ƒì´ì£ . ì´ ì‹œê°„ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ íŠ¹ì„±ì„ ê³ ë ¤í•˜ì—¬ ì ì ˆíˆ ì²˜ë¦¬í•´ì£¼ë©´ ë©ë‹ˆë‹¤.

```java
keepalive_timeout 3s;
```

ìœ„ ë°©ë²• ì„¤ì •ê°’ë“¤ì€ ì œ ë¶€í•˜í…ŒìŠ¤íŠ¸ API íŠ¹ì„±ìƒ ìì› ë‚­ë¹„ê°€ ê±°ì˜ ì—†ê³ , ì‘ë‹µì†ë„ê°€ ë¹ ë¥¸ í¸ì´ê¸° ë•Œë¬¸ì— ë§¤ìš° ì§§ê²Œ ì„¤ì •í•´ì¤¬ìŠµë‹ˆë‹¤. ì´ ì„¤ì •ê°’ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ ë° API ì˜ íŠ¹ì„±ì— ë”°ë¼ì„œ ì ì ˆíˆ ì„¤ì •í•´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤.

### ê¸°íƒ€ ì„±ëŠ¥ ê°œì„ ìš”ì†Œ

ì¶”ê°€ì ìœ¼ë¡œ [[CI/CD & Nginx] Worker Process íŠœë‹ìœ¼ë¡œ ë‹¤ìš´íƒ€ì„ì„ 0.015ì´ˆë¡œ ì¤„ì´ê¸° ê¹Œì§€ì˜ ê°œì„ ê³¼ì •](https://velog.io/@msung99/CICD-Nginx-Worker-Process-%ED%8A%9C%EB%8B%9D%EC%9C%BC%EB%A1%9C-%EB%8B%A4%EC%9A%B4%ED%83%80%EC%9E%84%EC%9D%84-0.015%EC%B4%88%EB%A1%9C-%EC%A4%84%EC%9D%B4%EA%B8%B0-%EA%B9%8C%EC%A7%80%EC%9D%98-%EA%B0%9C%EC%84%A0%EA%B3%BC%EC%A0%95) ì—ì„œ ë‹¤ë£¬ ë‚´ìš©ì´ì§€ë§Œ, http2 í”„ë¡œí† ì½œì„ ì ìš©í•˜ê±°ë‚˜, ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ íŠ¹ì„±ì— ë”°ë¼ Worker Process ì˜ ê°œìˆ˜ì™€ ì»¤ë„¥ì…˜ í—ˆìš©ìˆ˜ë¥¼ ì ì ˆíˆ ì¡°ì ˆí•¨ìœ¼ë¡œì¨ ì²˜ë¦¬ì†ë„ ë° ì„±ëŠ¥ ê°œì„ ì„ ì§„í–‰í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

### ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

ì„±ëŠ¥ì´ í¬ê²Œ ì¦ê°€í•˜ì§„ ì•Šì•˜ì§€ë§Œ, í‰ê·  ì•½ 0.009 ì´ˆì˜ ë‹¤ìš´íƒ€ì„ì„ ë³´ì´ëŠ” ê²ƒìœ¼ë¡œ ë³´ì•„ ìœ„ ê¸°ëŠ¥ë“¤ì„ ë„ì…í•œ ê²°ê³¼ê°€ ì—†ì§€ì•Šì•„ ì„±ëŠ¥ ê°œì„ ì— ìˆì–´ ë¯¸ì•½í•˜ê²Œë‚˜ë§ˆ ë„ì›€ì€ ëœë“¯í•©ë‹ˆë‹¤.

---

## ê²°ë¡ 

ê²°ë¡ ì„ ë‚´ë¦¬ìë©´, ì™„ë²½í•œ zero-downtime ì„ ë§Œë“¤ì–´ë‚´ëŠ” ê²ƒì€ keep-alive ë¥¼ í™œìš©í•˜ì§€ ì•Šê² ë‹¤ë©´ "ê°€ëŠ¥" í•˜ê³ , ê·¸ê²Œ ì•„ë‹ˆë¼ë©´ ì•„ì‰½ê²Œë„ "ë¶ˆê°€ëŠ¥" ì— ë§¤ìš° ê°€ê¹ë‹¤ë¼ê³  ë³´ëŠ”ê²Œ ë§ìŠµë‹ˆë‹¤. ëª°ë¡  ì €ë„ ëª¨ë¥´ëŠ” ëª¨ë‹ˆí„°ë§ ë„êµ¬ê°€ ìˆì–´ì„œ ì œê°€ ìƒê°í–ˆë˜ ìœ„ ì•„ì´ë””ì–´ê°€ ì‹¤ì œë¡œ êµ¬í˜„ëœë‹¤ë©´ ì œë¡œíƒ€ì„ì´ êµ¬í˜„ë  ìˆ˜ëŠ” ìˆë‹¤ê³ ë´…ë‹ˆë‹¤. í•˜ì§€ë§Œ Nginx ì—ì„œ ì œê³µë˜ëŠ” ê¸°ëŠ¥ ìì²´ë§Œìœ¼ë¡œëŠ” ë¶ˆê°€ëŠ¥í•˜ë‹¤ê³  ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

TCP ì»¤ë„¥ì…˜ì˜ ì—°ê²°ì„ ë§ºê³  ëŠëŠ” íƒ€ì´ë°ì„ ìœ„ì²˜ëŸ¼ ì¡°ì ˆí•œë‹¤ë©´, ì¦‰ keep-alive íŠ¹ì„±ì„ í™œìš©í•˜ì§€ ì•Šê² ë‹¤ë©´ ì‘ë‹µìœ¼ë¡œ connection = close ë¥¼ ë¬´ì¡°ê±´ ë¦¬í„´í•˜ê²Œ í•˜ëŠ” ìœ„ ë°©ì‹ë„ í™œìš©í•  ìˆ˜ëŠ” ìˆê² ìŠµë‹ˆë‹¤. ì´ ë°©ë²•ì„ í™œìš©ì‹œì—ëŠ” ì•ì„œ ì–¸ê¸‰ë“œë ¸ë“¯ì´, ì œë¡œ ë‹¤ìš´íƒ€ì„ì´ êµ¬í˜„ì€ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.

> ë˜í•œ, ë¬´ì—‡ë³´ë‹¤ ë‹¤ìš´íƒ€ì„ì˜ ì£¼ì›ì¸ì€ Connection: keep-alive ì¼ë•Œ TCP ì»¤ë„¥ì…˜ ì²˜ë¦¬ ë¬¸ì œë¡œ ì¸í•´ ë°œìƒí•œë‹¤ëŠ” ê²ƒì„ ì¦ëª…í•´ëƒˆìŠµë‹ˆë‹¤ !

---

## ì°¸ê³ 

- https://www.nginx.com/
- https://soonoo.me/docs/posts/2020/03/26/nginx-reload.html
- https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Connection
- https://datatracker.ietf.org/doc/html/rfc2616#section-8.1
